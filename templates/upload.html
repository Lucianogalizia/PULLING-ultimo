<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Subir Excel - MiApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="card-title text-center mb-4">1) Subí tu Excel</h2>
        <form id="step1-form">
          <div class="mb-3">
            <label for="excel_file" class="form-label">Selecciona tu archivo Excel</label>
            <input type="file" class="form-control" id="excel_file" accept=".xlsx,.xlsm">
          </div>
          <div class="d-grid">
            <button id="btn-step1" class="btn btn-primary">Cargar y marcar (Paso 1)</button>
          </div>
        </form>

        <div id="preview1" class="table-responsive mt-4"></div>

        <div class="mt-3">
          <button id="btn-step2" class="btn btn-secondary me-2" disabled>Paso 2: Filtros básicos</button>
          <button id="btn-step3" class="btn btn-secondary me-2" disabled>Paso 3: Normalizar pozos</button>
          <button id="btn-step4" class="btn btn-secondary me-2" disabled>Paso 4: Merge coords</button>
          <button id="btn-step5" class="btn btn-secondary"        disabled>Paso 5: Finalizar</button>
        </div>

        <div id="final-preview" class="table-responsive mt-4"></div>

        <div class="text-center mt-3">
          <a id="continue-link" href="{{ url_for('filter_zonas') }}"
             class="btn btn-success" style="display:none">
             Continuar a Filtrar Zonas
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Convierte un array de objetos JSON en una tabla HTML Bootstrap
    function toTable(data) {
      if (!data || !data.length) return '<p>No hay datos para mostrar.</p>';
      let html = '<table class="table table-striped"><thead><tr>';
      Object.keys(data[0]).forEach(c => html += `<th>${c}</th>`);
      html += '</tr></thead><tbody>';
      data.forEach(r => {
        html += '<tr>';
        Object.values(r).forEach(v => html += `<td>${v}</td>`);
        html += '</tr>';
      });
      html += '</tbody></table>';
      return html;
    }

    // Paso 1: carga y marcado
    document.getElementById('step1-form').addEventListener('submit', e => {
      e.preventDefault();
      const input = document.getElementById('excel_file');
      if (!input.files.length) return alert('Seleccioná un archivo Excel.');
      const form = new FormData();
      form.append('excel_file', input.files[0]);
      document.getElementById('btn-step1').disabled = true;
      fetch('/process/step1', { method:'POST', body: form })
        .then(r => r.json())
        .then(data => {
          document.getElementById('preview1').innerHTML = toTable(data);
          document.getElementById('btn-step2').disabled = false;
        })
        .catch(err => alert('Error en paso 1: '+err));
    });

    // Paso 2: filtros básicos
    document.getElementById('btn-step2').onclick = () => {
      this.disabled = true;
      fetch('/process/step2', { method:'POST' })
        .then(r => r.json())
        .then(data => {
          document.getElementById('preview1').innerHTML = toTable(data);
          document.getElementById('btn-step3').disabled = false;
        })
        .catch(err => alert('Error en paso 2: '+err));
    };

    // Paso 3: normalizar pozos
    document.getElementById('btn-step3').onclick = () => {
      this.disabled = true;
      fetch('/process/step3', { method:'POST' })
        .then(r => r.json())
        .then(data => {
          document.getElementById('preview1').innerHTML = toTable(data);
          document.getElementById('btn-step4').disabled = false;
        })
        .catch(err => alert('Error en paso 3: '+err));
    };

    // Paso 4: merge coords y aviso de faltantes
    document.getElementById('btn-step4').onclick = () => {
      this.disabled = true;
      fetch('/process/step4', { method:'POST' })
        .then(r => r.json())
        .then(json => {
          const msg = json.missing_pozos.length
            ? `<div class="alert alert-warning">Faltan coords para: ${json.missing_pozos.join(', ')}</div>`
            : `<div class="alert alert-success">Todas las coords encontradas</div>`;
          document.getElementById('preview1').insertAdjacentHTML('beforeend', msg);
          document.getElementById('btn-step5').disabled = false;
        })
        .catch(err => alert('Error en paso 4: '+err));
    };

    // Paso 5: preview final y habilitar continuar
    document.getElementById('btn-step5').onclick = () => {
      this.disabled = true;
      fetch('/process/step5', { method:'POST' })
        .then(r => r.text())
        .then(html => {
          document.getElementById('final-preview').innerHTML = html;
          document.getElementById('continue-link').style.display = 'inline-block';
        })
        .catch(err => alert('Error en paso 5: '+err));
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

